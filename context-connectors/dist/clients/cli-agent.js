/**
 * CLI Agent - Interactive AI agent for codebase Q&A.
 *
 * Uses AI SDK tools in an agentic loop for answering questions about
 * indexed codebases. Supports multiple LLM providers and both
 * interactive (REPL) and single-query modes.
 *
 * @module clients/cli-agent
 *
 * @example
 * ```typescript
 * import { CLIAgent } from "@augmentcode/context-connectors";
 *
 * const agent = new CLIAgent({
 *   client: searchClient,
 *   provider: "openai",
 *   model: "gpt-4o",
 * });
 * await agent.initialize();
 *
 * const response = await agent.ask("How does authentication work?");
 * console.log(response);
 * ```
 */
import { generateText, streamText, stepCountIs, } from "ai";
import { createAISDKTools } from "./ai-sdk-tools.js";
const DEFAULT_SYSTEM_PROMPT = `You are a helpful coding assistant with access to a codebase.

Available tools:
- search: Find relevant code using natural language queries
- listFiles: List files in the project (with optional glob filter)
- readFile: Read the contents of a specific file

When answering questions:
1. Use the search tool to find relevant code
2. Use listFiles to understand project structure if needed
3. Use readFile to examine specific files in detail
4. Provide clear, actionable answers based on the actual code

Be concise but thorough. Reference specific files and line numbers when helpful.`;
/**
 * Load a model from the specified provider.
 * Provider packages are optional - users only need to install the one they use.
 */
async function loadModel(provider, modelName) {
    switch (provider) {
        case "openai": {
            try {
                const { openai } = await import("@ai-sdk/openai");
                return openai(modelName);
            }
            catch {
                throw new Error(`OpenAI provider not installed. Run: npm install @ai-sdk/openai`);
            }
        }
        case "anthropic": {
            try {
                const { anthropic } = await import("@ai-sdk/anthropic");
                return anthropic(modelName);
            }
            catch {
                throw new Error(`Anthropic provider not installed. Run: npm install @ai-sdk/anthropic`);
            }
        }
        case "google": {
            try {
                const { google } = await import("@ai-sdk/google");
                return google(modelName);
            }
            catch {
                throw new Error(`Google provider not installed. Run: npm install @ai-sdk/google`);
            }
        }
        default:
            throw new Error(`Unknown provider: ${provider}`);
    }
}
/**
 * Interactive AI agent for codebase Q&A.
 *
 * The agent maintains conversation history, allowing for follow-up
 * questions. It uses the configured LLM to answer questions by
 * automatically calling search, listFiles, and readFile tools.
 *
 * @example
 * ```typescript
 * const agent = new CLIAgent({
 *   client: searchClient,
 *   provider: "openai",
 *   model: "gpt-4o",
 *   verbose: true, // Show tool calls
 * });
 *
 * await agent.initialize();
 *
 * // Ask questions
 * await agent.ask("What does this project do?");
 * await agent.ask("Show me the main entry point");
 *
 * // Reset for new conversation
 * agent.reset();
 * ```
 */
export class CLIAgent {
    client;
    model = null;
    provider;
    modelName;
    maxSteps;
    verbose;
    stream;
    systemPrompt;
    tools;
    messages = [];
    /**
     * Create a new CLI agent.
     *
     * Note: You must call `initialize()` before using the agent.
     *
     * @param config - Agent configuration
     */
    constructor(config) {
        this.client = config.client;
        this.provider = config.provider;
        this.modelName = config.model;
        this.maxSteps = config.maxSteps ?? 10;
        this.verbose = config.verbose ?? false;
        this.stream = config.stream ?? true;
        this.systemPrompt = config.systemPrompt ?? DEFAULT_SYSTEM_PROMPT;
        this.tools = createAISDKTools({ client: this.client });
    }
    /**
     * Initialize the agent by loading the model from the provider.
     *
     * Must be called before using `ask()`.
     *
     * @throws Error if the provider package is not installed
     */
    async initialize() {
        this.model = await loadModel(this.provider, this.modelName);
    }
    /**
     * Ask a question and get a response.
     *
     * The response is generated by the LLM, which may call tools
     * (search, listFiles, readFile) to gather information before
     * answering.
     *
     * The question and response are added to conversation history,
     * enabling follow-up questions.
     *
     * @param query - The question to ask
     * @returns The agent's response text
     * @throws Error if agent not initialized
     *
     * @example
     * ```typescript
     * const response = await agent.ask("How is authentication implemented?");
     * console.log(response);
     * ```
     */
    async ask(query) {
        if (!this.model) {
            throw new Error("Agent not initialized. Call initialize() first.");
        }
        this.messages.push({ role: "user", content: query });
        if (this.stream) {
            return this.streamResponse();
        }
        else {
            return this.generateResponse();
        }
    }
    async generateResponse() {
        const result = await generateText({
            model: this.model,
            tools: this.tools,
            stopWhen: stepCountIs(this.maxSteps),
            system: this.systemPrompt,
            messages: this.messages,
            onStepFinish: this.verbose ? this.logStep.bind(this) : undefined,
        });
        this.messages.push({ role: "assistant", content: result.text });
        return result.text;
    }
    async streamResponse() {
        const result = streamText({
            model: this.model,
            tools: this.tools,
            stopWhen: stepCountIs(this.maxSteps),
            system: this.systemPrompt,
            messages: this.messages,
            onStepFinish: this.verbose ? this.logStep.bind(this) : undefined,
        });
        let fullText = "";
        for await (const chunk of result.textStream) {
            process.stdout.write(chunk);
            fullText += chunk;
        }
        process.stdout.write("\n");
        this.messages.push({ role: "assistant", content: fullText });
        return fullText;
    }
    logStep(step) {
        if (step.toolCalls) {
            for (const call of step.toolCalls) {
                console.error(`\x1b[90m[tool] ${call.toolName}(${JSON.stringify(call.args ?? {})})\x1b[0m`);
            }
        }
    }
    /**
     * Reset conversation history.
     *
     * Use this to start a fresh conversation without tool context
     * from previous questions.
     */
    reset() {
        this.messages = [];
    }
    /**
     * Get a copy of the conversation history.
     *
     * @returns Array of messages (user and assistant turns)
     */
    getHistory() {
        return [...this.messages];
    }
}
//# sourceMappingURL=cli-agent.js.map